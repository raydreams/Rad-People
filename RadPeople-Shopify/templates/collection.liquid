{% comment %}
  Collection template - Product List
{% endcomment %}

<div class="product-list-container">
  <div class="filter-menu">
    <div class="filter-controls">
      {% comment %} View Grid Controls - Desktop Only {% endcomment %}
      {% if collection.products_count > 0 %}
        <div class="view-controls" style="position: relative;">
          <button type="button" class="grid-button" onclick="toggleViewModal()">
            View By (<span id="activeGrid">4</span>)
          </button>
          <div class="view-modal" id="viewModal">
            <button type="button" class="modal-button" data-columns="2" onclick="setGridColumns(2)">2</button>
            <button type="button" class="modal-button active" data-columns="4" onclick="setGridColumns(4)">4</button>
            <button type="button" class="modal-button" data-columns="8" onclick="setGridColumns(8)">8</button>
          </div>
        </div>
      {% endif %}
    </div>

    {% comment %} Sort Controls {% endcomment %}
    <div class="sort-controls" style="position: relative;">
      <button type="button" class="sort-button" onclick="toggleSortModal()">
        Sort By
      </button>
      <div class="sort-modal" id="sortModal">
        <button type="button" class="modal-button" onclick="sortProducts('date-new')">Date, New to Old</button>
        <button type="button" class="modal-button" onclick="sortProducts('date-old')">Date, Old to New</button>
        <button type="button" class="modal-button" onclick="sortProducts('price-high')">Price, High to Low</button>
        <button type="button" class="modal-button" onclick="sortProducts('price-low')">Price, Low to High</button>
      </div>
    </div>
  </div>

  {% if collection.products_count > 0 %}
    <div class="product-grid" id="productGrid" data-columns="4">
      {% for product in collection.products %}
        <a href="{{ product.url }}" class="product-link">
          <div class="product-card">
            <div class="image-wrapper">
              {% if product.featured_image %}
                <img 
                  src="{{ product.featured_image | image_url: width: 800 }}" 
                  alt="{{ product.featured_image.alt | escape }}"
                  class="product-image"
                  width="{{ product.featured_image.width }}"
                  height="{{ product.featured_image.height }}"
                  loading="lazy"
                >
              {% else %}
                {{ 'product-1' | placeholder_svg_tag: 'product-image' }}
              {% endif %}
            </div>
            <div class="product-details">
              <span class="product-name">{{ product.title }}</span>
              <span class="product-price">${{ product.price | money_without_currency }}</span>
            </div>
          </div>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <div style="padding: 40px; text-align: center;">
      <p>No products found in this collection.</p>
    </div>
  {% endif %}
</div>

{{ 'products.css' | asset_url | stylesheet_tag }}

<script>
  let activeGrid = 4;
  let currentSort = 'date-new';
  let products = Array.from(document.querySelectorAll('.product-link'));

  function setGridColumns(columns) {
    activeGrid = columns;
    const grid = document.getElementById('productGrid');
    grid.setAttribute('data-columns', columns);
    document.getElementById('activeGrid').textContent = columns;
    
    // Update active button
    document.querySelectorAll('.view-modal .modal-button').forEach(btn => {
      btn.classList.remove('active');
      if (parseInt(btn.getAttribute('data-columns')) === columns) {
        btn.classList.add('active');
      }
    });
    
    toggleViewModal();
  }

  function toggleViewModal() {
    const modal = document.getElementById('viewModal');
    modal.classList.toggle('open');
    
    // Close sort modal if open
    document.getElementById('sortModal').classList.remove('open');
  }

  function toggleSortModal() {
    const modal = document.getElementById('sortModal');
    modal.classList.toggle('open');
    
    // Close view modal if open
    document.getElementById('viewModal').classList.remove('open');
  }

  function sortProducts(sortType) {
    currentSort = sortType;
    const grid = document.getElementById('productGrid');
    
    products.sort((a, b) => {
      if (sortType === 'price-low') {
        const priceA = parseFloat(a.querySelector('.product-price').textContent.replace('$', ''));
        const priceB = parseFloat(b.querySelector('.product-price').textContent.replace('$', ''));
        return priceA - priceB;
      } else if (sortType === 'price-high') {
        const priceA = parseFloat(a.querySelector('.product-price').textContent.replace('$', ''));
        const priceB = parseFloat(b.querySelector('.product-price').textContent.replace('$', ''));
        return priceB - priceA;
      }
      return 0;
    });
    
    products.forEach(product => grid.appendChild(product));
    
    document.querySelectorAll('.sort-modal .modal-button').forEach(btn => {
      btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    toggleSortModal();
  }

  // Close modals when clicking outside
  document.addEventListener('click', function(event) {
    const viewModal = document.getElementById('viewModal');
    const sortModal = document.getElementById('sortModal');
    
    if (!event.target.closest('.view-controls')) {
      viewModal.classList.remove('open');
    }
    
    if (!event.target.closest('.sort-controls')) {
      sortModal.classList.remove('open');
    }
  });

  // Responsive grid adjustment
  function adjustGridForMobile() {
    if (window.innerWidth <= 768) {
      setGridColumns(2);
    } else if (activeGrid < 4) {
      setGridColumns(4);
    }
  }

  window.addEventListener('resize', adjustGridForMobile);
  adjustGridForMobile();
</script>

