{% comment %}
  Product template - Product Details
{% endcomment %}

<div class="breadcrumb-container">
  <a href="{{ routes.collections_url }}" class="breadcrumb-link">Product List</a>
  <span class="breadcrumb-arrow">â†’</span>
  <span class="breadcrumb-current">{{ product.title }}</span>
</div>

<div class="product-container">
  {% comment %} Image Section {% endcomment %}
  <div class="image-section" id="imageSection">
      {% for image in product.images %}
        <img 
          src="{{ image | image_url: width: 1200 }}" 
          alt="{{ image.alt | escape }}"
          class="product-image-detail"
          width="{{ image.width }}"
          height="{{ image.height }}"
          loading="lazy"
        >
      {% endfor %}
  </div>

  {% comment %} Product Summary {% endcomment %}
  <div class="product-summary" id="productSummary">
    <div class="title-row">
      <h1 class="product-title">{{ product.title }}</h1>
      <div class="product-price-detail">${{ product.price | money_without_currency }}</div>
    </div>

    {% comment %} Desktop Description {% endcomment %}
    <div class="desktop-description">
      <div class="product-description">
        {% assign description_items = product.description | split: '-' %}
        {% for item in description_items %}
          {% assign trimmed_item = item | strip %}
          {% if trimmed_item != blank %}
            <div class="description-item">{{ trimmed_item }}</div>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <div class="product-options">
      {% comment %} Color - using metafield {% endcomment %}
      {% if product.metafields.custom.color %}
        <div class="product-color">Color: {{ product.metafields.custom.color }}</div>
      {% endif %}

      {% comment %} Size Selection {% endcomment %}
      <div class="sizes-container">
        {% for option in product.options_with_values %}
          {% if option.name == 'Size' %}
            {% for value in option.values %}
              <button 
                type="button" 
                class="size-button" 
                data-size="{{ value }}"
                onclick="selectSize('{{ value }}')"
              >
                {{ value }}
              </button>
            {% endfor %}
          {% endif %}
        {% endfor %}
      </div>

      {% comment %} Add to Cart Button {% endcomment %}
      <form action="{{ routes.cart_add_url }}" method="post" enctype="multipart/form-data" id="product-form">
        <input type="hidden" name="id" id="selected-variant-id" value="">
        <input type="hidden" name="quantity" value="1">
        <button 
          type="submit" 
          class="add-to-cart-button" 
          id="addToCartButton"
          disabled
        >
          Add to cart
        </button>
        <div id="cart-feedback" class="feedback-message" style="display: none;"></div>
      </form>

      {% comment %} Shipping Info - using metafield {% endcomment %}
      {% if product.metafields.custom.shipping_weeks %}
        <div class="shipping-container">
          This product will ship in {{ product.metafields.custom.shipping_weeks }} weeks
        </div>
      {% else %}
        <div class="shipping-container">
          This product will ship in 4 weeks
        </div>
      {% endif %}
    </div>

    {% comment %} Mobile Description {% endcomment %}
    <div class="mobile-order-wrapper">
      <div class="product-description">
        {% assign description_items = product.description | split: '-' %}
        {% for item in description_items %}
          {% assign trimmed_item = item | strip %}
          {% if trimmed_item != blank %}
            <div class="description-item">{{ trimmed_item }}</div>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    {% comment %} Details Dropdowns {% endcomment %}
    <div class="dropdowns-wrapper">
      {% if product.metafields.custom.size_and_fit %}
        {% render 'details-dropdown', title: 'Size + Fit', content: product.metafields.custom.size_and_fit %}
      {% endif %}
      
      {% if product.metafields.custom.care %}
        {% render 'details-dropdown', title: 'Care', content: product.metafields.custom.care %}
      {% endif %}
    </div>
  </div>
</div>

{{ 'products.css' | asset_url | stylesheet_tag }}

<script>
  const product = {{ product | json }};
  let selectedSize = '';
  let selectedVariantId = '';

  function selectSize(size) {
    selectedSize = size;
    
    // Remove selected class from all buttons
    document.querySelectorAll('.size-button').forEach(btn => {
      btn.classList.remove('selected');
    });
    
    // Add selected class to clicked button
    event.target.classList.add('selected');
    
    // Find matching variant
    const variant = product.variants.find(v => {
      return v.options.some(opt => opt.toLowerCase() === size.toLowerCase());
    });
    
    if (variant) {
      selectedVariantId = variant.id;
      document.getElementById('selected-variant-id').value = variant.id;
      document.getElementById('addToCartButton').disabled = false;
    }
  }

  // Handle form submission
  document.getElementById('product-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!selectedVariantId) {
      showFeedback('Please select a size', 'error');
      return;
    }

    const button = document.getElementById('addToCartButton');
    button.disabled = true;
    button.textContent = 'Adding...';

    try {
      const formData = new FormData(this);
      const response = await fetch('{{ routes.cart_add_url }}', {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        button.textContent = 'Added to cart';
        showFeedback('Item added to cart', 'success');
        
        // Update cart count in navbar
        updateCartCount();
        
        // Dispatch cart update event
        document.dispatchEvent(new CustomEvent('cart:updated'));
        
        setTimeout(() => {
          button.textContent = 'Add to cart';
          button.disabled = false;
        }, 3500);
      } else {
        throw new Error('Failed to add to cart');
      }
    } catch (error) {
      showFeedback('Failed to add item to cart', 'error');
      button.disabled = false;
      button.textContent = 'Add to cart';
    }
  });

  function showFeedback(message, type) {
    const feedback = document.getElementById('cart-feedback');
    feedback.textContent = message;
    feedback.className = `feedback-message ${type}`;
    feedback.style.display = 'block';
    
    setTimeout(() => {
      feedback.style.display = 'none';
    }, 3000);
  }

  function updateCartCount() {
    fetch('{{ routes.cart_url }}.js')
      .then(response => response.json())
      .then(cart => {
        // Update cart indicators if they exist
        const indicators = document.querySelectorAll('.cart-indicator, .cart-icon-indicator');
        indicators.forEach(indicator => {
          if (cart.item_count > 0) {
            indicator.style.display = 'block';
            indicator.classList.add('pulse');
          } else {
            indicator.style.display = 'none';
          }
        });
      })
      .catch(error => console.error('Error updating cart count:', error));
  }

  // Desktop scroll locking logic
  if (window.innerWidth > 768) {
    const imageSection = document.getElementById('imageSection');
    const summarySection = document.getElementById('productSummary');
    
    if (imageSection && summarySection) {
      imageSection.addEventListener('scroll', function() {
        const imageScrollTop = imageSection.scrollTop;
        const imageScrollHeight = imageSection.scrollHeight - imageSection.clientHeight;
        
        if (imageScrollTop < imageScrollHeight) {
          summarySection.scrollTop = 0;
        }
      });
    }
  }

  // Dispatch cart update event
  document.dispatchEvent(new CustomEvent('cart:updated'));
</script>

<style>
  .desktop-description {
    display: block;
  }

  .mobile-order-wrapper {
    display: none;
  }

  @media (max-width: 768px) {
    .desktop-description {
      display: none;
    }

    .mobile-order-wrapper {
      display: block;
      margin-top: 20px;
    }
  }

  .dropdowns-wrapper {
    margin-top: 30px;
  }
</style>

