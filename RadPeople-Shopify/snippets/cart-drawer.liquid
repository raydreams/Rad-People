{% comment %}
  Cart Drawer Component
{% endcomment %}

<div class="cart-drawer-overlay" id="cartOverlay" onclick="closeCartDrawer()"></div>

<div class="cart-drawer" id="cartDrawer">
  <div class="cart-drawer-header">
    <h2 class="cart-drawer-title">CART</h2>
    <button type="button" class="cart-drawer-close" onclick="closeCartDrawer()">Ã—</button>
  </div>

  <div class="cart-drawer-content" id="cartContent">
    {% comment %} Cart items will be loaded via JavaScript {% endcomment %}
    <div class="cart-empty-message" id="emptyCartMessage" style="display: none;">
      YOUR CART IS EMPTY
    </div>
    <div class="cart-items-list" id="cartItemsList"></div>
  </div>

  <div class="cart-drawer-footer" id="cartFooter" style="display: none;">
    <div class="cart-total">
      <span>TOTAL</span>
      <span id="cartTotal">$0.00</span>
    </div>
    <a href="{{ routes.cart_url }}" class="cart-checkout-button">CHECKOUT</a>
  </div>
</div>

{{ 'cart.css' | asset_url | stylesheet_tag }}

<script>
  let cartData = null;

  async function loadCart() {
    try {
      const response = await fetch('{{ routes.cart_url }}.js');
      cartData = await response.json();
      renderCart();
    } catch (error) {
      console.error('Error loading cart:', error);
    }
  }

  function renderCart() {
    const cartItemsList = document.getElementById('cartItemsList');
    const emptyMessage = document.getElementById('emptyCartMessage');
    const cartFooter = document.getElementById('cartFooter');
    const cartTotal = document.getElementById('cartTotal');

    if (!cartData || cartData.items.length === 0) {
      cartItemsList.innerHTML = '';
      emptyMessage.style.display = 'block';
      cartFooter.style.display = 'none';
      return;
    }

    emptyMessage.style.display = 'none';
    cartFooter.style.display = 'flex';
    cartTotal.textContent = '$' + (cartData.total_price / 100).toFixed(2);

    cartItemsList.innerHTML = cartData.items.map(item => `
      <div class="cart-item-container" data-key="${item.key}">
        <img 
          src="${item.image}" 
          alt="${item.product_title}"
          class="cart-item-image"
          loading="lazy"
        >
        <div class="cart-item-details">
          <div class="cart-item-header">
            <h3 class="cart-item-name">${item.product_title}</h3>
            <p class="cart-item-price">$${(item.final_line_price / 100).toFixed(2)}</p>
          </div>
          ${item.variant_title ? `<p class="cart-item-size">${item.variant_title}</p>` : ''}
          <div class="cart-item-actions">
            <div class="quantity-control">
              <button 
                type="button" 
                class="quantity-button" 
                onclick="updateQuantity('${item.key}', ${item.quantity - 1})"
                ${item.quantity <= 1 ? 'disabled' : ''}
              >-</button>
              <span class="quantity-display">${item.quantity}</span>
              <button 
                type="button" 
                class="quantity-button" 
                onclick="updateQuantity('${item.key}', ${item.quantity + 1})"
              >+</button>
            </div>
            <button 
              type="button" 
              class="remove-button" 
              onclick="removeItem('${item.key}')"
            >Remove</button>
          </div>
        </div>
      </div>
    `).join('');
  }

  async function updateQuantity(key, quantity) {
    if (quantity < 1) {
      removeItem(key);
      return;
    }

    try {
      const response = await fetch('{{ routes.cart_change_url }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          id: key,
          quantity: quantity
        })
      });

      if (response.ok) {
        await loadCart();
        updateCartIndicators();
      }
    } catch (error) {
      console.error('Error updating quantity:', error);
    }
  }

  async function removeItem(key) {
    try {
      const response = await fetch('{{ routes.cart_change_url }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          id: key,
          quantity: 0
        })
      });

      if (response.ok) {
        await loadCart();
        updateCartIndicators();
      }
    } catch (error) {
      console.error('Error removing item:', error);
    }
  }

  function openCartDrawer() {
    const drawer = document.getElementById('cartDrawer');
    const overlay = document.getElementById('cartOverlay');
    drawer.classList.add('open');
    overlay.classList.add('open');
    document.body.style.overflow = 'hidden';
    loadCart();
  }

  function closeCartDrawer() {
    const drawer = document.getElementById('cartDrawer');
    const overlay = document.getElementById('cartOverlay');
    drawer.classList.remove('open');
    overlay.classList.remove('open');
    document.body.style.overflow = '';
  }

  function updateCartIndicators() {
    if (!cartData) return;

    const indicators = document.querySelectorAll('.cart-indicator, .cart-icon-indicator');
    indicators.forEach(indicator => {
      if (cartData.item_count > 0) {
        indicator.style.display = 'block';
        indicator.classList.add('pulse');
      } else {
        indicator.style.display = 'none';
      }
    });
  }

  // Close on escape key
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      closeCartDrawer();
    }
  });

  // Initial cart load
  loadCart();

  // Update cart when items are added
  document.addEventListener('cart:updated', function() {
    loadCart();
    updateCartIndicators();
  });
</script>

