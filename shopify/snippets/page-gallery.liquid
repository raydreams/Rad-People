{% comment %}
  Gallery Page - Fetches from Contentful API automatically
  Matches exact functionality: Image navigation, overlay grid, contact rectangle, control bar
{% endcomment %}

{{ 'contentful-api.js' | asset_url | script_tag }}

<div class="gallery-page-wrapper" id="galleryPage">
  <div class="gallery-loading" id="galleryLoading" style="display: block; padding: 2rem; text-align: center;">
    Loading gallery...
  </div>

  <div class="gallery-page-container" id="galleryContainer" style="display: none;">
    <div class="gallery-image-container" id="galleryImageContainer">
      <img class="gallery-image" id="galleryImage" src="" alt="" />
    </div>

    {% comment %} Contact Rectangle {% endcomment %}
    <div class="gallery-contact-rectangle">
      <h3>CONTACT</h3>
      <p>contact@radpeople.us</p>
      <p>agency@radpeople.us</p>
      <p>support@radpeople.us</p>
    </div>

    {% comment %} Control Bar {% endcomment %}
    <div class="gallery-control-bar">
      <div class="gallery-controls-group">
        <button class="gallery-control-button" onclick="toggleGalleryOverlay()">VIEW ALL</button>
      </div>
      <div class="gallery-controls-group">
        <span class="gallery-image-counter" id="galleryImageCounter">1 / 0</span>
        <button class="gallery-arrow-button gallery-left-arrow" onclick="goToPreviousImage()" aria-label="Previous image">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
        </button>
        <button class="gallery-arrow-button gallery-right-arrow" onclick="goToNextImage()" aria-label="Next image">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  {% comment %} Gallery Overlay {% endcomment %}
  <div class="gallery-overlay" id="galleryOverlay" style="display: none;">
    <div class="gallery-overlay-image-grid" id="galleryOverlayGrid">
      <!-- Images will be populated by JS -->
    </div>
    <div class="gallery-overlay-control-bar">
      <div class="gallery-controls-group">
        <button class="gallery-control-button" onclick="toggleGalleryOverlay()">CLOSE</button>
      </div>
      <div class="gallery-controls-group">
        <span class="gallery-image-counter" id="galleryOverlayCounter">0 IMAGES</span>
      </div>
    </div>
  </div>
</div>

<script>
  let galleryImages = [];
  let currentImageIndex = 0;
  let isOverlayOpen = false;
  let currentImageData = null;
  let cursor = 'e-resize';
  let screenWidth = window.innerWidth;

  // Wait for ContentfulAPI to be available
  function waitForContentfulAPI(callback, maxAttempts = 50) {
    let attempts = 0;
    const checkInterval = setInterval(() => {
      attempts++;
      if (typeof window.ContentfulAPI !== 'undefined') {
        clearInterval(checkInterval);
        callback();
      } else if (attempts >= maxAttempts) {
        clearInterval(checkInterval);
        console.warn('Contentful API not available after waiting. Using fallback content.');
        showFallbackContent();
      }
    }, 100);
  }

  // Load gallery images from Contentful
  async function loadGalleryImages() {
    try {
      if (typeof window.ContentfulAPI === 'undefined') {
        console.warn('Contentful API not available');
        showFallbackContent();
        return;
      }

      galleryImages = await window.ContentfulAPI.fetchGalleryImages();
      
      if (!galleryImages || galleryImages.length === 0) {
        console.warn('No gallery images found');
        showFallbackContent();
        return;
      }

      // Filter out images without valid URLs
      galleryImages = galleryImages.filter(img => img.imageUrl && img.imageUrl.length > 0);
      
      if (galleryImages.length === 0) {
        console.warn('No valid gallery images found after filtering');
        showFallbackContent();
        return;
      }

      renderGallery();
    } catch (error) {
      console.error('Error loading gallery images:', error);
      console.error('Error details:', error.message, error.stack);
      showFallbackContent();
    }
  }

  function renderGallery() {
    document.getElementById('galleryLoading').style.display = 'none';
    document.getElementById('galleryContainer').style.display = 'block';
    
    if (galleryImages.length > 0) {
      loadCurrentImage();
      renderOverlay();
      updateImageCounter();
    }
  }

  async function loadCurrentImage() {
    if (galleryImages.length === 0) return;

    const image = galleryImages[currentImageIndex];
    if (!image || !image.imageUrl) {
      console.error('Invalid image data:', image);
      return;
    }

    const imgEl = document.getElementById('galleryImage');
    const container = document.getElementById('galleryImageContainer');
    
    if (!imgEl || !container) return;

    // Preload image to get dimensions
    const img = new Image();
    img.src = image.imageUrl;
    
    try {
      await new Promise((resolve, reject) => {
        img.onload = resolve;
        img.onerror = () => reject(new Error(`Failed to load image: ${image.imageUrl}`));
        // Timeout after 10 seconds
        setTimeout(() => reject(new Error('Image load timeout')), 10000);
      });
    } catch (error) {
      console.error('Error loading image:', error);
      showFallbackContent();
      return;
    }

    const aspectRatio = img.naturalWidth / img.naturalHeight;
    let shouldFillScreen = false;
    let isWide = false;

    if (screenWidth <= 768) {
      shouldFillScreen = img.naturalHeight >= img.naturalWidth;
    } else {
      isWide = aspectRatio > 1.5;
      shouldFillScreen = isWide;
    }

    imgEl.src = image.imageUrl;
    imgEl.alt = image.description || 'Gallery image';
    
    // Apply styling based on dimensions
    if (shouldFillScreen) {
      imgEl.style.objectFit = 'cover';
      if (screenWidth > 768) {
        imgEl.style.width = isWide ? '100%' : 'auto';
        imgEl.style.height = '100%';
      } else {
        imgEl.style.width = '100%';
        imgEl.style.height = '100%';
      }
    } else {
      imgEl.style.objectFit = 'contain';
      imgEl.style.width = screenWidth > 768 ? 'auto' : '100%';
      imgEl.style.height = screenWidth > 768 ? '100%' : 'auto';
    }

    currentImageData = { src: image.imageUrl, fillScreen: shouldFillScreen, isWide };
  }

  function renderOverlay() {
    const overlayGrid = document.getElementById('galleryOverlayGrid');
    const overlayCounter = document.getElementById('galleryOverlayCounter');
    
    if (!overlayGrid) return;

    overlayGrid.innerHTML = galleryImages.map((image, index) => `
      <div class="gallery-overlay-image-wrapper" onclick="selectImageFromOverlay(${index})">
        <img src="${image.imageUrl}" alt="${image.description || ''}" />
      </div>
    `).join('');

    if (overlayCounter) {
      overlayCounter.textContent = `${galleryImages.length} IMAGES`;
    }
  }

  function goToNextImage() {
    if (isOverlayOpen) return;
    currentImageIndex = (currentImageIndex + 1) % galleryImages.length;
    loadCurrentImage();
    updateImageCounter();
  }

  function goToPreviousImage() {
    if (isOverlayOpen) return;
    currentImageIndex = (currentImageIndex - 1 + galleryImages.length) % galleryImages.length;
    loadCurrentImage();
    updateImageCounter();
  }

  function selectImageFromOverlay(index) {
    currentImageIndex = index;
    loadCurrentImage();
    updateImageCounter();
    toggleGalleryOverlay();
  }

  function toggleGalleryOverlay() {
    isOverlayOpen = !isOverlayOpen;
    const overlay = document.getElementById('galleryOverlay');
    if (overlay) {
      overlay.style.display = isOverlayOpen ? 'flex' : 'none';
    }
  }

  function updateImageCounter() {
    const counter = document.getElementById('galleryImageCounter');
    if (counter) {
      counter.textContent = `${currentImageIndex + 1} / ${galleryImages.length}`;
    }
  }

  function handleGalleryClick(event) {
    if (isOverlayOpen) return;

    const container = event.currentTarget;
    const { clientX, currentTarget } = event;
    const { left, width } = currentTarget.getBoundingClientRect();
    const clickPosition = clientX - left;

    if (screenWidth <= 768 || clickPosition > width / 2) {
      goToNextImage();
    } else {
      goToPreviousImage();
    }
  }

  function handleGalleryMouseMove(event) {
    if (isOverlayOpen || screenWidth <= 768) return;

    const { clientX, currentTarget } = event;
    const { left, width } = currentTarget.getBoundingClientRect();
    const mousePosition = clientX - left;
    cursor = mousePosition < width / 2 ? 'w-resize' : 'e-resize';
    
    const container = document.getElementById('galleryContainer');
    if (container) {
      container.style.cursor = cursor;
    }
  }

  function showFallbackContent() {
    document.getElementById('galleryLoading').innerHTML = `
      <p>No gallery images found. Gallery images will be displayed here when available.</p>
    `;
  }

  function handleResize() {
    screenWidth = window.innerWidth;
    if (galleryImages.length > 0 && currentImageData) {
      loadCurrentImage();
    }
  }

  window.addEventListener('resize', handleResize);

  document.addEventListener('DOMContentLoaded', function() {
    screenWidth = window.innerWidth;
    const container = document.getElementById('galleryContainer');
    if (container) {
      container.addEventListener('click', handleGalleryClick);
      container.addEventListener('mousemove', handleGalleryMouseMove);
    }
    waitForContentfulAPI(loadGalleryImages);
  });
</script>

<style>
  .gallery-page-wrapper {
    position: fixed;
    top: 40px;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: white;
    overflow: hidden;
  }

  .gallery-page-container {
    position: fixed;
    top: 40px;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
  }

  .gallery-image-container {
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }

  .gallery-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    user-drag: none;
    -webkit-user-drag: none;
    user-select: none;
    -moz-user-select: none;
    -webkit-user-select: none;
    -ms-user-select: none;
    position: absolute;
  }

  @media (min-width: 769px) {
    .gallery-image {
      height: 100%;
    }
  }

  @media (max-width: 768px) {
    .gallery-image {
      width: 100%;
    }
  }

  .gallery-contact-rectangle {
    position: absolute;
    top: 12px;
    right: 5px;
    background-color: #0000FF;
    color: white;
    padding: 15px;
    border: 1px solid #000000;
    font-family: 'Sequel Sans', sans-serif;
    z-index: 10;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    font-size: 0.6rem;
    width: 225px;
    height: 120px;
  }

  @media (max-width: 768px) {
    .gallery-contact-rectangle {
      width: 110px;
      height: 160px;
      right: 8px;
    }
  }

  @media (max-width: 480px) {
    .gallery-contact-rectangle {
      width: 60px;
      height: 180px;
      font-size: 0.3rem;
    }
  }

  .gallery-contact-rectangle h3 {
    margin: 0 0 10px 0;
    font-size: 1rem;
  }

  .gallery-contact-rectangle p {
    margin: 5px 0;
  }

  .gallery-control-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 4vh;
    background-color: white;
    border-top: 1px solid #000000;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 max(5px, calc((100vw - 100%) / 2));
    z-index: 100;
  }

  .gallery-controls-group {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .gallery-control-button {
    background-color: transparent;
    border: none;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    padding: 5px;
    font-size: 12px;
    color: black;
    font-family: 'Sequel Sans Regular', sans-serif;
    text-transform: uppercase;
  }

  .gallery-control-button:focus {
    outline: none;
  }

  .gallery-arrow-button {
    background-color: transparent;
    border: none;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    padding: 5px;
    color: black;
  }

  .gallery-right-arrow {
    margin-right: 15px;
  }

  .gallery-arrow-button svg {
    width: 18px;
    height: 18px;
    stroke-width: 1.5;
  }

  .gallery-image-counter {
    font-family: 'Sequel Sans Regular', sans-serif;
    font-size: 12px;
    color: black;
  }

  .gallery-overlay {
    position: fixed;
    top: 40px;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: white;
    z-index: 999;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    display: flex;
    flex-direction: column;
    border-top: 1px solid #000000;
  }

  .gallery-overlay-image-grid {
    display: flex;
    flex-wrap: wrap;
    padding: 25px;
    padding-bottom: 250px;
    column-gap: 20px;
    row-gap: 8px;
  }

  @media (max-width: 768px) {
    .gallery-overlay-image-grid {
      padding: 15px;
      padding-bottom: 7vh;
      column-gap: 12px;
      row-gap: 8px;
    }
  }

  .gallery-overlay-image-wrapper {
    height: 140px;
    flex-grow: 0;
    flex-shrink: 0;
    cursor: pointer;
  }

  @media (max-width: 768px) {
    .gallery-overlay-image-wrapper {
      height: 100px;
    }
  }

  .gallery-overlay-image-wrapper img {
    height: 100%;
    width: auto;
    object-fit: contain;
    display: block;
    margin: 0;
    padding: 0;
    line-height: 0;
  }

  .gallery-overlay-control-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 4vh;
    background-color: white;
    border-top: 1px solid #000000;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 max(5px, calc((100vw - 100%) / 2));
    z-index: 1002;
  }
</style>
